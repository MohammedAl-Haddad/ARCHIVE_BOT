حاضر ✅ — هذا هو **التوثيق الكامل** لملفي الإعدادات اللذين أنهينا دراستهما:
`bot/config/constants.py` و `bot/config/__init__.py` — مع كل ما ناقشناه وخلاصة عملية للاستخدام والاختبار وإعادة الهيكلة.

# توثيق: bot/config/constants.py

## الغرض

* تعريف ثوابت إعدادات **غير سرّية** تُستخدم داخل حزمة الإعدادات.

## الواجهة العامة (Interfaces)

* `ENV_FILE: str = ".env"` — مسار ملف المتغيرات البيئية الذي سيتم تحميله (يُستهلك داخل `__init__.py`) .

## الاعتمادات (Dependencies)

* لا يعتمد على مكتبات خارجية؛ مجرد تعريف ثابت.

## العلاقات مع الملفات الأخرى

* يُستَورد في `bot/config/__init__.py` لتمرير المسار إلى `load_dotenv` قبل قراءة المتغيرات البيئية .

---

# توثيق: bot/config/**init**.py

## الغرض

* **تحميل القيم من ملف البيئة** (`.env`) وتهيئتها كمتغيرات إعداد عالمية متاحة لباقي المشروع.
* توفير وقت بدء التشغيل `START_TIME` لاستخدامات مثل uptime.

## أهم ما يفعله الملف

1. تحميل `.env` عبر `dotenv.load_dotenv(ENV_FILE)` (حيث `ENV_FILE` من `constants.py`) .
2. قراءة متغيرات البيئة الأساسية والتحقق منها:

   * `BOT_TOKEN` (إجباري) — يُرفع استثناء عند غيابه .
   * `ARCHIVE_CHANNEL_ID` (إجباري) — يُحوَّل لعدد صحيح وإلا يُرفع استثناء .
   * `OWNER_TG_ID` (إجباري) — نفس آلية التحويل والتحقق .
3. قراءة متغيرات اختيارية:

   * `GROUP_ID` (اختياري) — رقم مجموعة (قد يُستخدم لسيناريوهات خاصة) .
   * `ADMIN_USER_IDS` — قائمة IDs مفصولة بفواصل تُحوّل إلى قائمة أعداد صحيحة .
   * `VERSION` — من `COMMIT_SHA` وإلاّ القيمة الافتراضية `"dev"` .
   * `START_TIME` — `datetime.now()` لحظة الإقلاع .

## الواجهة العامة (المتغيرات المصدَّرة)

* `BOT_TOKEN: str`
* `ARCHIVE_CHANNEL_ID: int`
* `GROUP_ID: int | None`
* `OWNER_TG_ID: int`
* `ADMIN_USER_IDS: list[int]`
* `VERSION: str`
* `START_TIME: datetime`

> تُستخدم هذه القيم من باقي الحزم. مثالان مباشرَان:
>
> * في نقطة الدخول `bot/main.py`: يستورد `BOT_TOKEN, OWNER_TG_ID` لتجهيز التطبيق ومنح صلاحيات المالك عند الإقلاع .
> * في قاعدة البيانات/الإدارة `bot/db/admins.py`: يستورد `ADMIN_USER_IDS, OWNER_TG_ID` لمنطق التحقق من الصلاحيات والمالك .

## الدوال والـ Helpers

* `_to_int(env_key: str) -> int | None`
  دالة داخلية لتحويل قيمة بيئية إلى عدد صحيح أو `None` إن كانت فارغة/غير معرّفة (تُستخدم مع الحقول الرقمية مثل IDs) .

## الاعتمادات (Dependencies)

* `os` لقراءة البيئة، `datetime` لوقت البدء، `dotenv.load_dotenv` لتحميل `.env`، واستيراد `ENV_FILE` من `constants.py` .

## مبادئ ومفاهيم برمجية في الملف

* **Configuration via Environment Variables** (التكوين عبر البيئة).
* **Fail Fast**: رفع أخطاء مبكرة عند نقص الإعدادات الحرجة.
* **Helper/DRY**: استعمال دالة `_to_int` لتوحيد تحويل القيم الرقمية.
* **Type Hints حديثة**: استعمال `int | None` (اختصار `Optional[int]`).

## أخطاء/حالات فشل محتملة وكيفية التعامل

* غياب `BOT_TOKEN`، `ARCHIVE_CHANNEL_ID`، أو `OWNER_TG_ID` ⇒ يرفع `RuntimeError` مع رسالة واضحة (أول نقطة يجب فحصها عند فشل الإقلاع) .
* قيم IDs غير رقمية في `.env` ⇒ مع الصيغة الحالية قد يحدث `ValueError` داخل `int(...)` (يظهر كمشكلة أثناء التحويل).

---

# أمثلة عملية

## نموذج ملف `.env` (حدّث حسب بيئتك)

```dotenv
# Telegram / Auth
BOT_TOKEN=123456:ABCDEF-your-telegram-bot-token

# Archive channel (سالب لقنوات خاصة عادةً)
ARCHIVE_CHANNEL_ID=-1001234567890

# Owner (معرّف تيليجرام الرقمي)
OWNER_TG_ID=123456789

# اختياري:
GROUP_ID=
ADMIN_USER_IDS=111111111,222222222
COMMIT_SHA=7f9c2d1
```

## أماكن الاستهلاك في المشروع

* `bot/main.py`:

  * يستخدم `BOT_TOKEN` لبناء التطبيق و`OWNER_TG_ID` لضمان صلاحيات المالك عند التشغيل .
* `bot/db/admins.py`:

  * يستخدم `OWNER_TG_ID` و`ADMIN_USER_IDS` للتحقق من المالك/المشرفين والصلاحيات (bitmask) .

---

# اختبارات سريعة (Smoke / Unit Hints)

1. **إقلاع بدون .env**

   * احذف/أعد تسمية `.env` وشغّل: يجب أن ترى `RuntimeError: BOT_TOKEN is missing in .env` (وهي إشارة سليمة) .

2. **قيمة غير رقمية** لـ `OWNER_TG_ID`

   * ضع `OWNER_TG_ID=abc` وتوقّع فشل التحويل (يجب إصلاح القيمة إلى رقم صحيح).

3. **ADMIN\_USER\_IDS**

   * جرّب `ADMIN_USER_IDS=1,  2 ,x,  3` وتحقّق أن القائمة الناتجة `[1,2,3]` فقط (يُهمل غير الرقمي) .

---

# اقتراح إعادة هيكلة (كما ناقشنا) — **Config Object**

> الهدف: تنظيم الإعدادات في **كائن واحد** قابل للحقن في الاختبارات، مع رسائل تحقق أدقّ، مع **توافق خلفي** مرحلي.

## الفكرة

* إضافة `bot/config/config.py` يحوي:

  * `@dataclass(frozen=True) class Config`
  * `Config.from_env()` لتحميل `.env` وبناء الكائن.
* تعديل `bot/config/__init__.py` ليصدّر:

  * `config = Config.from_env()`
  * والمتغيرات القديمة (`BOT_TOKEN`… إلخ) **كإعادة تصدير** من خصائص `config` للحفاظ على التوافق.

## الفوائد

* **قابلية الاختبار**: يمكن بناء `Config` ببيئة مزيّفة في الاختبارات.
* **تنظيم**: نقطة إعداد مركزية بدلاً من Globals متفرّقة.
* **قابلية التوسّع**: لاحقًا يمكن إضافة محمل بديل (YAML/JSON) داخل `Config` دون كسر المستهلكين.

## التأثيرات على بقية الملفات

* لا شيء فوري (بفضل التوافق الخلفي).
* **تحسين اختياري** لاحقًا: استبدال

  ```python
  from bot.config import BOT_TOKEN
  ```

  بـ

  ```python
  from bot.config import config
  app = ApplicationBuilder().token(config.BOT_TOKEN).build()
  ```

  كما في `main.py` و `db/admins.py` (مجرّد تحسين للوضوح) .

---

# ملاحظات ومعايير كتابة الكود

* **تسمية واضحة للحقول** ومطابقة أسماء `.env`، وتوثيق ما هو Required/Optional.
* **رسائل أخطاء دقيقة** للمفاتيح المفقودة/غير الصالحة.
* **عدم تسريب أسرار** في اللوجز (لا تطبع `BOT_TOKEN`).
* **تثبيت تبعية dotenv** في `requirements.txt` (موجودة لديك).
* **التشغيل على ويندوز**: إصلاح الـ event loop يتم في `main.py` (تم بالفعل)، وليس في config.

---

## TL;DR

* `constants.py`: يحدّد فقط `ENV_FILE=".env"` .
* `__init__.py`: يحمّل `.env` ويعرّف متغيرات الإعداد الأساسية مع تحقق مبكر، ويعرّف `START_TIME` و`VERSION`، ويقدّم `ADMIN_USER_IDS` كقائمة أرقام جاهزة للاستخدام .
* الاستخدام متكامل مع `main.py` و`db/admins.py` كما هو الآن، ويمكن ترقيته تدريجيًا نحو `Config` كائني دون كسر التوافق.
