# Mechatronics Archive Bot — دليل التشغيل ومحاكاة الأمثلة (المستوى الأول)

> **الغرض:** ملف عملي يجمع *كل الأمثلة* والنصوص الجاهزة لتشغيل البوت على تيليجرام (رفع ↔ اعتماد ↔ تصفّح)، مع سيناريوهات ربط المجموعة والـTopics، وإدارة الحالات الخاصة. مركز على **المستوى الأول** مع الإشارة للترم الأول أساسًا.

**مختصر المواصفات الثابتة للمشروع**
- لغة التشغيل: **Python 3.12** — مكتبة **python-telegram-bot v20+**.
- قاعدة البيانات: **SQLite / aiosqlite** (المخطط المرجعي في `database/init.sql`).
- تشغيل ويندوز: قبل `app.run_polling()` تأكد من **WindowsSelectorEventLoopPolicy** وإنشاء/الحصول على حدث حلقة `asyncio` (Fix معروف على Windows 3.12).
- التصفّح بالأزرار **ديناميكي من قاعدة البيانات** (لا قوائم ثابتة). منطق `echo_handler` لا يُغيَّر.
- الاعتماد (Approve) شرط لظهور المواد في التصفّح.

---

## جدول المحتويات
1. [قواعد القراءة والتحليل](#rules)
2. [التهيئة السريعة وتشغيل البوت](#quickstart)
3. [ربط المجموعة والترم](#link-group)
4. [ربط الـTopic بالمادة/القسم](#link-topic)
5. [لوحة أنواع المحتوى (الوسوم)](#types)
6. [أمثلة الرفع — نظري](#examples-theory)
7. [أمثلة الرفع — عملي](#examples-lab)
8. [أمثلة الرفع — مناقشة](#examples-discussion)
9. [الملزمة والنماذج](#booklets-exams)
10. [التوصيف وجدول الحضور والخطة الدراسية](#descriptors)
11. [الألبومات (MediaGroup)](#albums)
12. [التكرار والاستبدال](#dup)
13. [أخطاء شائعة ورسائل ودّية](#errors)
14. [محاكاة كاملة لمسار مادة](#full-sim)
15. [قوالب جاهزة للنسخ واللصق](#templates)
16. [ملاحظات إدارية وأمنية](#admin-notes)

---

## 1) قواعد القراءة والتحليل <a id="rules"></a>
- التحليل يعتمد على **نص الكابتشن فقط** (لا Telegram entities).
- السنة هجرية فقط: `#1446` أو `#١٤٤٦` (1300–1600)، ويُسمح بـ `هـ`.
- استبدال `_` بمسافة في العرض: `الدكتور_صالح` → "الدكتور صالح".
- `#المحاضرة_1` تُعرض "المحاضرة **الأولى**" … و`10` → "العاشرة".
- التصفّح يعرض **المعتمد فقط** (approved). غير المعتمد لا يظهر في القوائم.
- عند الضغط على أي زر في التصفّح، يرسل البوت **نفس رسالة الأرشيف** (copyMessage).
- في المجموعات لا يوجد رد "الخيار غير معروف…"؛ هذه الرسالة محصورة على الخاص.

---

## 2) التهيئة السريعة وتشغيل البوت <a id="quickstart"></a>
**خطوات مختصرة (Windows/PowerShell):**
```pwsh
# 1) تفعيل بيئة عمل
python -m venv .bot_venv
.bot_venv\Scripts\Activate.ps1

# 2) تثبيت الحزم
python -m pip install --upgrade pip
pip install python-telegram-bot aiosqlite python-dotenv pyyaml

# 3) متغيرات .env
# TELEGRAM_BOT_TOKEN=123456:ABC...
# OWNER_TG_ID=123456789

# 4) تهيئة قاعدة البيانات (إن لزم)
python -m bot.db.init_db

# 5) تشغيل (مع إصلاح حلقة ويندوز)
python -m bot.main
```
> **ملاحظة:** تأكد من سياسة **WindowsSelectorEventLoopPolicy** قبل `run_polling()` على 3.12 لضمان عمل الـasync.

---

## 3) ربط المجموعة بالترم <a id="link-group"></a>
1. في **المجموعة** (وليس الخاص) أرسل:
   ```
   /insert_group
   ```
2. سيطلب منك: **"المستوى – الترم"** (مثال: `المستوى الأول - الترم الأول`).
3. عند **تأكيد** الإدخال يحفَظ الربط للمجموعة: **term = المستوى الأول / الترم الأول**.

---

## 4) ربط الـTopic بمادة/قسم <a id="link-topic"></a>
1. داخل **Topic** بالمجموعة أرسل:
   ```
   /insert_sub
   ```
2. أرسل إحدى الصيغتين:
   - `اسم المادة - القسم` مثل: `دوائر كهربائية (1) - عملي` → يربط مباشرة بالقسم.
   - `اسم المادة` فقط مثل: `لغة عربية (1)` → يسأل: **"هل المادة نظري فقط؟"**
     - **نعم** → `theory_only=1` ويتم **تخطي شاشة اختيار الأقسام** في التصفّح.
     - **لا** → `theory_only=0` ويربط الـTopic افتراضيًا بقسم **نظري** (قابل للتعديل لاحقًا).

---

## 5) لوحة أنواع المحتوى (الوسوم) <a id="types"></a>
**ملخص سريع (الأكثر استخدامًا):**

| النوع | هل يتطلب عنوان محاضرة؟ | هل يتطلب سنة؟ | ملاحظات |
|---|---|---|---|
| `#موجز_يومي` | نعم (`#المحاضرة_X: عنوان`) | نعم (`#1446`) | يظهر تحت المحاضرة |
| `#صور_السبورة` | نعم | نعم | يدعم ألبومات الصور |
| `#السلايدات` | يفضل | اختياري/مستحسن | يمكن ربطه بمحاضر |
| `#التسجيل_الصوتي` | يفضل | نعم |  |
| `#التسجيل_الفيديو` | يفضل | نعم |  |
| `#تفريغ_صوتي` | نعم | نعم |  |
| `#ملخص_الطلاب`/`#ملخصات_الطلاب` | نعم | نعم |  |
| `#ملف_التجربة` (عملي) | نعم | نعم |  |
| `#محاكاة` (عملي) | نعم | نعم |  |
| `#تقرير_عملي` (عملي) | نعم | نعم |  |
| `#الملزمة` | — | نعم | يمكن إضافة محاضر |
| `#نموذج_النصفي` | — | نعم | يظهر ضمن "النماذج" |
| `#نموذج_النهائي` | — | نعم | يظهر ضمن "النماذج" |
| `#التوصيف` | — | — | زر في واجهة المادة |
| `#جدول_الحضور` | — | — | يظهر في واجهة الترم |
| `#الخطة_الدراسية` + سطر المستوى/الترم | — | — | يُرسل عادة من الخاص |

> **تذكير:** يمكن إضافة `#الدكتور_فلان`/`#الأستاذ_فلان`/`#المهندس_فلان` لاستخدام مسار **حسب المحاضر**.

---

## 6) أمثلة الرفع — **نظري** <a id="examples-theory"></a>
**التوبك مربوط:** `دوائر كهربائية (1) – نظري`.

### 6.1 موجز يومي
```
#موجز_يومي
#المحاضرة_1: أساسيات التيار المستمر
#1446
#الدكتور_صالح
```
**التصفّح المتوقع:**
- المستويات → المستوى الأول → الترم الأول → المواد → دوائر كهربائية (1) → **نظري** → **حسب السنة** → `1446` → المحاضرات → **المحاضرة الأولى** → **موجز يومي**
- … أو: **حسب المحاضر** → **الدكتور صالح** → **المحاضرة الأولى** → **موجز يومي**

### 6.2 صور السبورة
```
#صور_السبورة
#المحاضرة_1: أساسيات التيار المستمر
#1446
#الدكتور_صالح
```
**التصفّح:** نفس مسار 6.1 وتظهر بجانب **موجز يومي**.

### 6.3 السلايدات (اختياري العنوان)
```
#السلايدات
#المحاضرة_2: الدارة المفتوحة والمغلقة
#1446
#الدكتور_صالح
```

### 6.4 تسجيلات
```
#التسجيل_الصوتي
#المحاضرة_2: الدارة المفتوحة والمغلقة
#1446
```
```
#التسجيل_الفيديو
#المحاضرة_3: المقاومة المكافئة
#1446
```

### 6.5 تفريغ صوتي
```
#تفريغ_صوتي
#المحاضرة_3: المقاومة المكافئة
#1446
#الدكتور_سامي
```

### 6.6 ملخصات الطلاب
```
#ملخص_الطلاب
#المحاضرة_5: قانون أوم
#1446
```
> يدعم أيضًا: `#ملخصات_الطلاب`.

### 6.7 سنة إضافية لنفس المحاضرة
```
#موجز_يومي
#المحاضرة_1: أساسيات التيار المستمر
#1447
#الدكتور_صالح
```
- يظهر في **حسب السنة** الآن: `[1446] [1447]`.

---

## 7) أمثلة الرفع — **عملي** <a id="examples-lab"></a>
**التوبك مربوط:** `دوائر كهربائية (1) – عملي`.

### 7.1 ملف التجربة
```
#ملف_التجربة
#المحاضرة_1: قياس التيار والجهد
#1446
#المهندس_علي
```

### 7.2 محاكاة
```
#محاكاة
#المحاضرة_2: محاكاة دارة تقسيم الجهد
#1446
#المهندس_ليث
```

### 7.3 تقرير عملي
```
#تقرير_عملي
#المحاضرة_2: محاكاة دارة تقسيم الجهد
#1446
```
> **اقتراحات اختيارية:** `#نتائج_المعمل` و`#نموذج_التقرير` كبنود ضمن عملي.

---

## 8) أمثلة الرفع — **مناقشة** <a id="examples-discussion"></a>
**التوبك مربوط:** `دوائر كهربائية (1) – مناقشة`.

### 8.1 صور السبورة
```
#صور_السبورة
#المحاضرة_4: مسائل على قانون أوم
#1446
#الأستاذ_طارق
```

### 8.2 ملخصات الطلاب
```
#ملخصات_الطلاب
#المحاضرة_4: مسائل على قانون أوم
#1446
```

---

## 9) الملزمة والنماذج <a id="booklets-exams"></a>
### 9.1 الملزمة
```
#الملزمة
#1446
#الدكتور_صالح
```
- تظهر في **نظري → حسب السنة → 1446 → الملزمة**.
- وتظهر أيضًا في **نظري → حسب المحاضر → الدكتور صالح → ملزمة الدكتور صالح**.

### 9.2 نموذج النصفي/النهائي
```
#نموذج_النصفي
#1446
#الدكتور_صالح
```
```
#نموذج_النهائي
#1446
```
- واجهة التصفّح: زر **النماذج** يفتح `[النصفي] [النهائي]` إن وُجدا معًا، أو زر واحد عند تفرّد نوع.

---

## 10) التوصيف وجدول الحضور والخطة الدراسية <a id="descriptors"></a>
### 10.1 توصيف المادة
```
#التوصيف
```
- يُرفع داخل Topic مربوط بالمادة (أي قسم)، ويظهر زر **📄 التوصيف** في واجهة المادة.

### 10.2 جدول الحضور
```
#جدول_الحضور
```
- يُرفع في المجموعة (خارج Topics المربوطة) من مندوب/مشرف. يظهر زر **جدول الحضور** في واجهة **الترم**.

### 10.3 الخطة الدراسية (من الخاص)
```
#الخطة_الدراسية
المستوى الأول - الترم الأول
```
- عند التأكيد يُربط كـ `term_resource(kind='study_plan')`. يظهر زر **الخطة الدراسية** في واجهة الترم.

---

## 11) الألبومات (MediaGroup) <a id="albums"></a>
- إذا أُرسلت صور متعددة كألبوم مع نفس الوسوم:
  - يؤرشف كـ **عنصر واحد** عبر أول رسالة في المجموعة ويُربط `group_id` إن أمكن.
  - التصفّح يرسل **منشور الأرشيف الأساسي** للألبوم.

---

## 12) التكرار والاستبدال <a id="dup"></a>
- إذا كانت الوسوم **مطابقة 100%** (مادة/قسم/سنة/محاضرة/نوع/محاضر/عنوان): تظهر لوحة **[استبدال] [إلغاء]**.
- عند الاستبدال وبعد الاعتماد:
  - تُنسخ الرسالة الجديدة إلى الأرشيف ويُحدَّث `storage_message_id` و`file_unique_id`.
- إذا كانت **نفس المحاضرة والسنة** لكن **عنوان مختلف**: يقبل كعنصرين ضمن نفس المحاضرة.

---

## 13) أخطاء شائعة ورسائل ودّية <a id="errors"></a>
1. **نوع يحتاج عنوان محاضرة** ولم يُكتب:
   - رد: "رجاءً أضف عنوانًا: `#المحاضرة_1: <العنوان>`".
2. **سنة مفقودة** فيما يتطلب سنة:
   - رد: "أضف سنة هجرية مثل: `#1446`".
3. **وسم غير مدعوم**:
   - رد بقائمة الأنواع المدعومة.
4. **رفع في الخاص** لنوع يتطلب Topic مربوط:
   - رد: "هذا النوع يُرسل في مجموعة داخل Topic مربوط بالمادة".
5. **تعارض مع ربط الـTopic**:
   - تحذير ثم إلغاء الإدخال.
6. **فشل نسخ الأرشيف** (حُذفت الرسالة الأصل):
   - رد: "العنصر غير متاح حاليًا" + تسجيل لوج للمطور.

---

## 14) محاكاة كاملة لمسار مادة <a id="full-sim"></a>
**الفرض:** المجموعة مربوطة بـ "المستوى الأول/الترم الأول"، وTopics:
- `[نظري]` دوائر كهربائية (1)
- `[عملي]` دوائر كهربائية (1)
- `[مناقشة]` دوائر كهربائية (1)

**خطوات مختصرة:**
1) موجز يومي (نظري) للمحاضرة 1 سنة 1446 → اعتماد → يظهر في التصفّح.
2) صور السبورة للمحاضرة 1 (نظري) → تظهر بجانب الموجز.
3) سلايدات للمحاضرة 2 (نظري) → مع أو بدون محاضر.
4) محاكاة للمحاضرة 2 (عملي) باسم المهندس.
5) ملخصات الطلاب للمحاضرة 4 (مناقشة).
6) الملزمة 1446 (نظري) + نموذج النصفي 1446.
7) توصيف المادة + جدول حضور + الخطة الدراسية للترم.
8) تجربة استبدال عنصر بنفس الوسوم للتحقق من منطق التكرار.

---

## 15) قوالب جاهزة للنسخ واللصق <a id="templates"></a>
**موجز يومي (نظري):**
```
#موجز_يومي
#المحاضرة_1: <عنوان المحاضرة>
#1446
#الدكتور_<الاسم>
```
**صور السبورة (نظري/مناقشة):**
```
#صور_السبورة
#المحاضرة_2: <عنوان>
#1446
#الأستاذ_<الاسم>
```
**السلايدات (نظري):**
```
#السلايدات
#المحاضرة_3: <عنوان>
#1446
```
**محاكاة (عملي):**
```
#محاكاة
#المحاضرة_4: <عنوان>
#1446
#المهندس_<الاسم>
```
**ملخصات الطلاب:**
```
#ملخص_الطلاب
#المحاضرة_5: <عنوان>
#1446
```
**الملزمة:**
```
#الملزمة
#1446
#الدكتور_<الاسم>
```
**النصفي/النهائي:**
```
#نموذج_النصفي
#1446
#الدكتور_<الاسم>
```
```
#نموذج_النهائي
#1446
```
**التوصيف:**
```
#التوصيف
```
**جدول الحضور (خارج Topic مربوط):**
```
#جدول_الحضور
```
**الخطة الدراسية (من الخاص):**
```
#الخطة_الدراسية
المستوى الأول - الترم الأول
```

---

## 16) ملاحظات إدارية وأمنية <a id="admin-notes"></a>
- **الأدوار:** `OWNER` يُقرأ من `.env` عبر `OWNER_TG_ID` ويمنح كامل الصلاحيات (upsert_owner). جدول `admins` يضم الأعمدة مع فهرس فريد لـ `tg_user_id`.
- **إدارة المشرفين:** أوامر خاصة في الخاص (مثل `/admins`) لاضافة/تعطيل/حذف مشرفين مع منع تعديل المالك.
- **مصادقة الإدخالات:** أي إدخال يُمرر عبر حالة pending → اعتماد → نشر في الأرشيف.
- **قابلية التوسّع:** كل الأنواع قابلة للإضافة كـ `category`/`section` جديدة بدون كسر التصفّح.

> **انتهى الدليل — المستوى الأول**. انسخ الأقسام كما هي إلى رسائل تيليجرام لتجربة البوت خطوة بخطوة.

