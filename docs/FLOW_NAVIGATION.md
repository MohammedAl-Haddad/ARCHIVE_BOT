# نظام توليد الأزرار والتنقّل (FLOW_NAVIGATION)

هذا المستند يشرح كيفية عمل شجرة التنقّل في البوت بدءًا من تخزين المسار، مرورًا ببناء القوائم والفلاتر، وحتى الترحيل بين الصفحات.

## تخزين المسار بـ `NavStack`
- يتم حفظ المسار لكل مستخدم داخل `context.user_data["nav_stack"]` على هيئة مكدس من العناصر.
- العنصر يمثل عقدة بالشكل `(kind, id, title)`:
  - `kind`: نوع العقدة (مثل `level` أو `subject`).
  - `id`: المعرف المرتبط بالعقدة ويمكن أن يكون عددًا أو سلسلة أو مجموعة معرفات.
  - `title`: التسمية المعروضة للمستخدم.
- يوفر `NavStack` عمليات الدفع (`push`) والسحب (`pop`) واسترجاع النص الكامل للمسار (`path_text`)【F:bot/navigation/nav_stack.py†L5-L52】.

## أنواع العقد ومسار التنقّل
التنقّل يسير وفق أنواع العقد التالية بالتسلسل:

```
root → level → term → term_option → subject → section → section_option →
year → year_option → lecturer → lecture → lecture_type
```

يحدد القاموس `CHILD_KIND` نوع الأبناء لكل عقدة، مما يسمح بالتحقق من الصلاحيات وبناء المسار الصحيح【F:bot/navigation/tree.py†L185-L197】.

## تحميل الأبناء والكاش قصير العمر
- يتم تحميل عناصر القائمة lazily عن طريق الدالة `_load_children`.
- لتحسين الأداء يتم تخزين آخر نتيجة في `context.user_data["last_children"]` مع ختم زمني.
- إذا تم طلب نفس العقدة خلال `CACHE_TTL_SECONDS` (90 ثانية)، تُعاد النتيجة من الكاش بدلاً من إعادة الاستعلام عن قاعدة البيانات【F:bot/handlers/navigation_tree.py†L69-L172】.

## ترجمة التسميات
يتم تحويل الرموز الداخلية إلى تسميات عربية مع رموز تعبيرية قبل عرضها:
- **أقسام المادة** `SECTION_LABELS` (مثل "نظري 📘" أو "عملي 🔬")【F:bot/handlers/navigation_tree.py†L43-L49】.
- **البطاقات** `CARD_LABELS` (مثل "التوصيف 📄" أو "مراجع 📚")【F:bot/handlers/navigation_tree.py†L51-L59】.
- **أنواع محتوى المحاضرة** `LECTURE_TYPE_LABELS` (مثل "السلايدات 📑" أو "الفيديو 🎥")【F:bot/db/materials.py†L6-L16】.

## تقسيم الصفحات
- يتم تحديد عدد العناصر في كل صفحة عبر المتغير `PER_PAGE` في الإعدادات (القيمة الافتراضية 8)【F:bot/config/config.py†L24-L76】.
- عند بناء لوحة الأزرار يستعمل `build_children_keyboard` هذا العدد ويضيف أزرار "◀" و"▶" للتنقّل بين الصفحات مع زر "🔙" للرجوع【F:bot/keyboards/builders/paginated.py†L11-L76】.

## مثال رحلة كاملة
النموذج التالي يوضّح رحلة من القائمة الرئيسية وصولًا إلى محتوى محاضرة، مع أثر كل خطوة على المكدس:

```
[القائمة الرئيسية]
└─ 📚 المستويات
```
1. **ضغط "المستوى الأول"**
   - المكدس ← `[('level', 1, 'المستوى الأول')]`
2. **اختيار "الترم الأول"**
   - المكدس ← `[('level', 1, 'المستوى الأول'), ('term', (1, 1), 'الترم الأول')]`
3. **فتح "مادة الرياضيات"**
   - المكدس ← `[... , ('subject', 5, 'الرياضيات')]`
4. **الدخول إلى قسم "نظري"**
   - المكدس ← `[... , ('section', (5, 'theory'), 'نظري 📘')]`
5. **فلترة حسب السنة ثم اختيار "1446"**
   - المكدس ← `[... , ('year', (5, 'theory', 1446), '1446')]`
6. **اختيار المحاضر "د. أحمد"**
   - المكدس ← `[... , ('lecturer', (5, 'theory', 1446, 3), 'د. أحمد')]`
7. **فتح "محاضرة 1"**
   - المكدس ← `[... , ('lecture', 1, 'محاضرة 1')]`
8. **اختيار نوع المحتوى "السلايدات"**
   - يتم إرسال المادة للمستخدم وتبقى العقدة في الأعلى لاستخدام زر الرجوع.

كل مرة يضغط المستخدم زرًا جديدًا يتم دفع عقدة جديدة إلى المكدس، وزر "🔙" يسحب آخر عقدة ويعيده للمستوى السابق.
```
[بعد الوصول]
المسار: المستوى الأول / الترم الأول / الرياضيات / نظري 📘 / 1446 / د. أحمد / محاضرة 1
```

بهذا يكون المستخدم قد تنقّل من المستوى الأعلى حتى مادة محاضرة محددة مع إمكانية الرجوع خطوة بخطوة أو العودة مباشرة للقائمة الرئيسية عند تفريغ المكدس.

