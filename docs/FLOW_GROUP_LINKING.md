# تدفق ربط المجموعات والمواضيع (FLOW_GROUP_LINKING)

يوضح هذا المستند كيفية ربط مجموعة تيليجرام أو Topic بمادة وقسم داخل قاعدة البيانات، وكيفية تعديل الربط أو إلغائه.

## مخطط التسلسل
```
المالك يرسل الأمر (/insert_group أو /insert_sub)
→ البوت يطلب البيانات من المستخدم
→ التحقق من الصلاحيات وصحة الإدخال
→ كتابة السجل في قاعدة البيانات (جدول groups أو topics)
→ إرسال رسالة نجاح أو فشل
```

## أوامر البداية والدوال المستقبلة
- `/insert_group` داخل مجموعة خارقة: يبدأ محادثة **ربط المجموعة** عبر `insert_group_conv` الذي يستدعي الدوال `insert_group_start`، `insert_group_received`، ثم `insert_group_confirm`.
- `/insert_sub` داخل Topic في مجموعة: يبدأ محادثة **ربط Topic** عبر `insert_sub_conv` الذي يستدعي الدوال `insert_sub_start`، `insert_sub_received`، `insert_sub_theory_choice`، ثم `insert_sub_confirm`.

## الجداول والحقول المتأثرة
| العملية | الجدول | الحقول المكتوبة |
|---------|-------|------------------|
| ربط مجموعة | `groups` | `tg_chat_id`, `level_id`, `term_id`, `title` |
| ربط Topic  | `topics` | `group_id`, `tg_topic_id`, `subject_id`, `section` |
| ضبط المادة كنظري فقط (اختياري) | `subjects` | `sections_mode` (`set_theory_only`) |

## السيناريوهات
### 1. ربط جديد
#### ربط مجموعة
1. المستخدم: `/insert_group`
2. البوت: "اربط هذه المجموعة بالمستوى والترم" + أزرار (**إدخال يدوي**, **إلغاء**).
3. المستخدم يضغط **إدخال يدوي** ثم يرسل `المستوى الأول - الترم الأول`.
4. البوت يعرض رسالة تأكيد مع أزرار (**تأكيد**, **إلغاء**).
5. عند الضغط على **تأكيد** يُنشأ أو يُحدّث سجل في جدول `groups`.
6. البوت يرسل "تم الربط بنجاح".

#### ربط Topic
1. داخل Topic: `/insert_sub`
2. البوت يطلب `اسم المادة - القسم` أو `اسم المادة` فقط.
3. المستخدم يرسل `دوائر كهربائية - نظري`.
4. البوت يعرض تأكيدًا بالقسم والنظري فقط = لا.
5. عند الضغط على **تأكيد**:
   - يتحقق من أن المجموعة مرتبطة بالمستوى والترم.
   - يتم إنشاء المادة إن لم تكن موجودة ثم ضبط `sections_mode` حسب الاختيار.
   - يتم إدخال أو تحديث سجل في جدول `topics`.
6. البوت يرسل "تم الربط بنجاح".

### 2. تعديل ربط موجود
- تنفيذ الأمر نفسه مرة أخرى سيعرض الربط الحالي وزر **تعديل الربط**.
- عند اختيار التعديل تُعاد خطوات الربط السابقة مع كتابة القيم الجديدة في الجداول نفسها.

### 3. حذف الربط
- لا يوجد أمر مباشر لحذف الربط.
- يمكن التعديل إلى مادة/قسم آخر أو حذف السجل يدويًا من قاعدة البيانات (`DELETE FROM groups` أو `DELETE FROM topics`).

### 4. التراجع أثناء المحادثة
- الضغط على زر **إلغاء** في أي مرحلة ينهي المحادثة دون تعديل قاعدة البيانات ويظهر إشعار "تم الإلغاء".

### 5. استعلام حالة الربط
- لا يوجد أمر منفصل لعرض الحالة.
- تشغيل `/insert_group` أو `/insert_sub` يعرض الربط الحالي (إن وجد) قبل اختيار **تعديل الربط** أو **إلغاء**.

## أمثلة محادثة كاملة
### ربط مجموعة جديد
```
المستخدم: /insert_group
البوت: اربط هذه المجموعة بالمستوى والترم. [إدخال يدوي] [إلغاء]
المستخدم يضغط: إدخال يدوي
البوت: أرسل: المستوى - الترم
المستخدم: المستوى الأول - الترم الأول
البوت: سيتم ربط هذه المجموعة بـ: المستوى الأول - الترم الأول [تأكيد] [إلغاء]
المستخدم يضغط: تأكيد
البوت: تم الربط بنجاح.
```

### ربط Topic جديد
```
المستخدم داخل Topic: /insert_sub
البوت: اربط هذا الـTopic بمادة/قسم. أرسل: «اسم المادة - القسم» أو «اسم المادة» فقط.
المستخدم: دوائر كهربائية (1) - نظري
البوت: سيتم ربط هذا الـTopic بـ:
       المادة: دوائر كهربائية (1)
       القسم: نظري
       نظري فقط: لا
       [تأكيد] [إلغاء]
المستخدم يضغط: تأكيد
البوت: تم الربط بنجاح.
```

### إلغاء أثناء المحادثة
```
المستخدم: /insert_group
البوت: اربط هذه المجموعة بالمستوى والترم. [إدخال يدوي] [إلغاء]
المستخدم يضغط: إلغاء
البوت: تم الإلغاء.
```

### تعديل ربط Topic موجود
```
المستخدم داخل Topic: /insert_sub
البوت: هذا الـTopic مربوط حاليًا بـ: دوائر كهربائية — نظري. [تعديل الربط] [إلغاء]
المستخدم يضغط: تعديل الربط
البوت: أرسل: «اسم المادة - القسم» أو «اسم المادة» فقط.
المستخدم: رياضيات - عملي
البوت: سيتم ربط هذا الـTopic بـ:
       المادة: رياضيات
       القسم: عملي
       نظري فقط: لا
       [تأكيد] [إلغاء]
المستخدم يضغط: تأكيد
البوت: تم الربط بنجاح.
```

## ملاحظات
- يجب أن يكون المستخدم مالك البوت أو لديه صلاحية `MANAGE_GROUPS` لاستخدام هذه الأوامر.
- تنفيذ `/insert_sub` يتطلب أن تكون المجموعة مربوطة مسبقًا عبر `/insert_group`.
- الحقول الأساسية المستخدمة: `groups.tg_chat_id`, `groups.level_id`, `groups.term_id`, `topics.tg_topic_id`, `topics.subject_id`, `topics.section`.
