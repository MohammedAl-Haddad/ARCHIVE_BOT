# الأداء

يوضح هذا الدليل كيف يتعامل البوت مع التحميل الكسول، الكاش، والصفحات لضمان استجابة سريعة وتقليل الضغط على قاعدة البيانات.

## التحميل الكسول
- تستخدم شجرة التنقل بنية **Node** التي تجلب أبناء كل عقدة فقط عند الطلب.
- بعد الاستعلام الأول، يتم حفظ النتيجة في كاش داخلي بحيث لا يُعاد الاستعلام عن نفس العقدة خلال فترة قصيرة.

## الكاش
### كاش شجرة التنقل
- يتم حفظ نتائج أبناء كل عقدة في كاش داخل الذاكرة لمدة `CACHE_TTL_SECONDS` (90 ثانية) لكل مستخدم وعقدة؛ المفتاح يحوي معرف المستخدم، نوع العقدة والمعرفات المرتبطة بها.
- إذا طُلبت نفس العقدة ضمن هذه المدة، تُعاد النتيجة من الكاش بدلاً من الوصول إلى قاعدة البيانات، مما يمنع الاستعلامات المكررة.

### كاش آخر الأبناء
- تحتفظ الدالة `_load_children` في `context.user_data["last_children"]` بآخر قائمة أبناء تم تحميلها مع ختم زمني.
- عند التنقل بين الصفحات أو العودة لنفس العقدة خلال `LAST_CHILDREN_TTL_SECONDS` (نفس قيمة `CACHE_TTL_SECONDS`)، تُستخدم القائمة المخزّنة بدلًا من إعادة تحميلها.

## الصفحات و PER_PAGE
- تُبنى لوحة الأزرار بواسطة `build_children_keyboard`، وتستخدم القيمة `PER_PAGE` من الإعدادات لتحديد عدد العناصر في كل صفحة.
- القيمة الافتراضية `8` عناصر لكل صفحة ويمكن تغييرها عبر متغير البيئة `PER_PAGE`.
- مثال: وجود 20 عنصرًا مع `PER_PAGE=8` ينتج 3 صفحات (8 + 8 + 4). إذا كانت `PER_PAGE=5` فسيتم تقسيمها إلى 4 صفحات (5 عناصر لكل صفحة).

## نصائح ضبط
- للمنشآت الكبيرة (1500+ مستخدم):
  - زيادة `CACHE_TTL_SECONDS` (مثلاً إلى 120 ثانية) تقلل الضغط على قاعدة البيانات لكن تؤخر ظهور التحديثات.
  - رفع `PER_PAGE` (مثلًا إلى 12) يقلل عدد الصفحات والرسائل المتبادلة، مع مراعاة حدود Telegram لعدد الأزرار.
  - في بيئات متعددة العمليات، استخدم كاشًا خارجيًا مشتركًا (مثل Redis) لأن الكاش الحالي داخل ذاكرة العملية فقط.
  - راقب استهلاك الذاكرة وزمن الاستجابة واضبط الموارد (RAM/CPU) وفقًا للحمل الفعلي.
