# تدفق الرفع/الإدخال (FLOW_INGESTION)

يوضح هذا المستند خطوات استلام الرسالة الموسومة، تحليل الوسوم، نسخ الرسالة إلى قناة الأرشيف ثم حفظ البيانات في قاعدة البيانات.

## مخطط التسلسل
```
رسالة في المجموعة تحتوي وسومًا
→ parse_hashtags (تنظيف ثم استخراج)
→ ingestion_handler يتحقق من الصلاحيات والربط
→ insert_material + insert_ingestion
→ إرسال تأكيد مؤقت للمرسل
→ copy_message إلى المالك للمراجعة
→ عند الموافقة: copy_message إلى قناة الأرشيف
→ update_material_storage لتخزين معرفات التخزين
```

## ترتيب التحليل
`parse_hashtags` يمر بالمراحل التالية:
1. **التطبيع**: إزالة علامات الاتجاه وتحويل الأرقام العربية إلى لاتينية عبر `_clean`【F:bot/parser/hashtags.py†L27-L36】.
2. **تجزئة السطور**: استخراج كل سطر يبدأ بـ`#` للحفاظ على الترتيب【F:bot/parser/hashtags.py†L254-L266】.
3. **الاستخراج**: يتم المرور على الوسوم لاكتشاف نوع المحتوى، القسم، السنة، المحاضر ورقم المحاضرة مع التحقق من الترتيب المطلوب【F:bot/parser/hashtags.py†L269-L348】【F:bot/parser/hashtags.py†L355-L371】.

## ما يُنسخ وما يُخزن
- عند قبول المحتوى يتم نسخ الرسالة الأصلية إلى قناة الأرشيف المحددة في الإعدادات `ARCHIVE_CHANNEL_ID` باستخدام `copy_message`【F:bot/handlers/approvals.py†L90-L97】【F:bot/config/config.py†L12-L17】.
- بعد النسخ يتم تحديث سجل المادة بحقول التخزين:
  - `tg_storage_chat_id`
  - `tg_storage_msg_id`
  - `file_unique_id`
  وذلك عبر `update_material_storage`【F:bot/db/materials.py†L98-L107】.

## ربط الحقول بالأصناف
`insert_material` ينشئ سجلاً في جدول `materials` ويستقبل الحقول التالية【F:bot/db/materials.py†L51-L76】:

| الحقل | المصدر | الوصف |
|-------|--------|-------|
| `subject_id` | الربط (Topic) | المادة المرتبطة بالرسالة |
| `section` | `ParsedHashtags.section` أو الربط | نظري/عملي... |
| `category` | `ParsedHashtags.content_type` | نوع المحتوى (slides, lecture...) |
| `title` | عنوان المحاضرة أو الملف | اسم يظهر للزائر |
| `year_id` | `ParsedHashtags.year` بعد تحويلها إلى سجل `years` | السنة الهجرية |
| `lecturer_id` | `ParsedHashtags.lecturer` بعد إدراج المحاضر | اسم المحاضر |
| `source_chat_id`، `source_topic_id`، `source_message_id` | سياق الرسالة الأصلية | تُستخدم للرجوع لاحقًا |
| `tg_storage_chat_id`, `tg_storage_msg_id`, `file_unique_id` | يتم ملؤها بعد الموافقة | مكان التخزين في قناة الأرشيف |

## أمثلة رسائل
### رسالة صحيحة
```
#slides
#المحاضرة_1: دوائر كهربائية
#1445
#الدكتور_أحمد
```
**رد البوت:**
```
✅ تم الاستلام. رقم العملية: #123
سيتم إشعارك بعد المراجعة.
```
*مقتبس من منطق الرد في `ingestion_handler`*【F:bot/handlers/ingestion.py†L312-L321】

### رسالة مرفوضة (ترتيب وسوم خاطئ)
```
#1445
#slides
```
**رد البوت:**
```
رجاءً اتّبع ترتيب الوسوم لهذا النوع: #slides
#المحاضرة_1: العنوان
#1446
#الدكتور_اسم (اختياري)
```
*نفس رسالة الخطأ الناتجة عن `parse_hashtags` عند ترتيب وسوم غير صحيح*【F:bot/parser/hashtags.py†L355-L371】

## نتيجة الموافقة
عند ضغط المسؤول على زر **Approve** تُنسخ الرسالة إلى قناة الأرشيف ويُحدَّث السجل ببيانات التخزين، وعند الرفض يُحذف السجل أو يُترك دون نسخ حسب نوع العملية.

